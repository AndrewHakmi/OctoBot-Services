notifications:
  email: false
sudo: enabled
os: linux
language: python
python: 3.8-dev
cache: pip
env:
  global:
    - GH_REPO=Drakkar-Software/OctoBot-Services
    - DEPLOY_BRANCH=master
    - PACKAGE_FOLDER=octobot_services
    - secure: apv6/DPB7AKIjsevHn6F6GQty4AU3AFX4GYQqRfAeLingK4zHQ9SWAvbI7pwvhF2MJ6l0fDaOtV6nhuptt1SCwAn5+O/gltj6Mc/ohsZzbj8+39UTBazOnocdlQFpjIxwUHOC3AT89MjOH2JBGanZiM240ewxKsGK5L4SJ6YHfRNXzz+4ul3SvyaBL+ThqI0k3X42Bfu1SxYdDfzYzm9VOk69y/8Ny1SvSxaBpPW/V0No64QDcYe7FXsrau1a2UrPcHRNyAmQ7l1lbXscQITgzMLKOsYGYGTTUoyAl0RVvL28OQl0ZDHM0TVRcVBtu43VSyzul/8mOj4ZZE9bDbisVxXXziG2thEFmVzZV1xthPbhR33cxUGRF6JUAiVWJ4+big7IvCaLTcuFAyqrxvHZ1frGi1bW0csHHSyj5oLhZrsalg9TPhGwCk/s62gKY2CF/WzmsPzsQhVILJGT1KRfPqGOOc11QwSIWKlWNGEndJWGEoLVZO9Jz/c/nbS6urVA/6UNirOa/EFfZXEnYexz6iw8JHIsrRHxDF6Sy5HW5iLsvyNqz3IDJobWzcYqgGVGcpw1ayCRl41lmosMBg0L/uuHLh4kEK5yJadFMYoxL0A8rSOIBrBgFCcg+MukZF2+44+AS9HAIOP4AEMumM9ix8o+NCY8ZKl3QeZcmwwnVo=
    - secure: bIB3h/jSnyi8CzEmegzhfXtqnmNEOGfVG+mu04xzR880kaVh214qI8vR8T9m0+oFnBTdqN31pgjBHtyDiv3rGjIKwQ6OimZ8WRCxfHjqvtTvV2/9GRN/WhhtbJo/cJAdCJBf8i0/KSWN9jEOhmjPqM1vsl+ddg8tmTZgOhTvl2by4ZTF8OOYjzoGUDkJZnAL16rea8JqU/ZiQmpNAUnNzAyxSkIQ49OFNuZ5vM5o69xhPwmyADJCKmcjhTcNVjJec2xxn/Hmeu76MM/HMLgYcKky0q7MxUtSUcFzEwtQPKJjq7TONWJcd8p3ZeBI4WKi+y6niqQC84GlmtLOINhIXI7xukDZ1XMIN+Sd58wqoiGyGjSr3ayXy1fw4B5TbYK9kwsddDcj5glnP6Fa7CA7j6fVLEKB4GuliIFXU9hCRdf7kNiwjykJStMI1o6de0zUKvRmssaj4kWZWLxBf2DpPewaMTHd107H1MvUQqtMvFG49xyl1s7eEM49WBi0KZ1my3IY9x/B97XNhVpyB5YpAKpzO8n96oumV4Y4F8Ck4Abl6CN0+K1JM5xJJT72c5ViE2S37JElk7H7wdjxuoMl2yV8kQz23c5ko3/T0KV6wg6fl7/SpM3SZ3UBFfSBecG94HYMzktFPc1v/FyUjJtWp4uL7Hef8D2tAVDYMVkhRHg=

install:
  - python3 -m pip install --prefer-binary -r dev_requirements.txt -r requirements.txt

matrix:
  include:
    - name: "Linux - Python 3.8-dev - Python sources"
      stage: test
      os: linux
      python: 3.8-dev
      language: python
      script:
        - pytest --cov=. --cov-config=.coveragerc --durations=0 -rw tests
      after_success:
        - if [ $TRAVIS_PULL_REQUEST == "false" ]; then coveralls; fi

    - name: "Linux - Python 3.8-dev - Installed"
      stage: test
      os: linux
      python: 3.8-dev
      language: python
      script:
        - python3 setup.py build_ext --inplace
        - python3 setup.py install
        - rm -rf $PACKAGE_FOLDER
        - pytest tests

    - name: "Linux - Python 3 - Deploy"
      stage: deploy
      script:
        - ls
      deploy:
        - provider: pypi
          user: "__token__"
          password:
            secure: RFAdYo5+NhovKvU3PPlY+IDKNFni3b5tJWNegLLUgotgD6XfAACEXCi0MhZfdLGnFyuB/5L6i4W2VMiAqE9ToiEPxJ9gqJHC539Wp0hPXs1nXMNIB4U1imbT0h2agr+cejKWhGN7EkayYlZUAJAMQKXo3+ERokleE09Z/pSoW5jx/qU3aKjsBoTwKCN3Le+onzpw+5csvfjL5MQisM4AfvTV913hdJ43uKe0lByJI1uwwZIw80vaBvtw6BTt8v+DyZrWvmLExhjnmHGJycuLftbeknjhAUCpCU3mFYkVYDB9HO4DC4OOAueZfEr4fk19SaiUShrdJ3rU8Iyr+5KyS1xGBBZUSnNaRFbioogQM0pPjGv9KG1QmN08bMwCcNo8w5aNhu+w6S32+bak6YMUExsmqZwq2Cr6axo/XfHu/Cf6YTgTw9HdInoIuX6tdf+MBThV6vcjdDuP7otX9YgJ2XnTa2WqIp0N9uuAoeJTvDa8YpCPimfIfSitfsshHDWS+l/ETbFlajeChMQo9RLzZ/7wH/kAVn6oriyFnWDUZKPvQ3KSFsfyBbTKHc7f+lTZw06ZvyeM2eH2HgIhbQlwY3ShUZqoq5CxoPKDMHEdHuurPl74nTyitgSVK0SgGcBDO1hrH9kXNYQI++VZ5xwlJLQeV6ytD1/4avDqDCXyYq8=
          skip_cleanup: true
          skip_existing: true
          distributions: "sdist"
          on:
            repo: $GH_REPO
            branch: $DEPLOY_BRANCH
            tags: true
            condition: $TRAVIS_OS_NAME = 'linux'
        - provider: script
          script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/octobot-pypi-deploy:i686 "i686" "cp37-cp37m" "cp37"
          skip_cleanup: true
          skip_existing: true
          on:
            repo: "$GH_REPO"
            branch: "$DEPLOY_BRANCH"
            tags: true
            condition: "$TRAVIS_OS_NAME = 'linux'"
        - provider: script
          script: docker run -it -e PYPI_USERNAME=$PYPI_USERNAME -e PYPI_PASSWORD=$PYPI_PASSWORD -v $(pwd):/project drakkarsoftware/octobot-pypi-deploy:x86_64 "x86_64" "cp37-cp37m" "cp37"
          skip_cleanup: true
          on:
            repo: "$GH_REPO"
            branch: "$DEPLOY_BRANCH"
            tags: true
            condition: "$TRAVIS_OS_NAME = 'linux'"

    - name: "OSX - Python 3.7 - Deploy"
      stage: deploy
      os: osx
      osx_image: xcode11    # Python 3.7.2 running on macOS 10.14.3
      language: shell       # 'language: python' is an error on Travis CI macOS
      # python: 3.7         # 'python:' is ignored on Travis CI macOS
      before_install: python3 --version ; pip3 --version ; sw_vers
      install:
        - python3 -m pip install --prefer-binary --user -r requirements.txt
        - python3 -m pip install --prefer-binary -r dev_requirements.txt
      before_cache:
        - rm -f "$HOME/Library/Caches/pip/log/debug.log"
      cache:
        directories:
          - "$HOME/Library/Caches/pip"
      script:
        - python3 setup.py build_ext --inplace
        - pytest testss
      deploy:
        - provider: script
          script: python3 setup.py bdist_wheel && python3 -m twine upload dist/* -u $PYPI_USERNAME -p $PYPI_PASSWORD --skip-existing
          skip_cleanup: true
          on:
            repo: "$GH_REPO"
            branch: "$DEPLOY_BRANCH"
            tags: true
            condition: "$TRAVIS_OS_NAME = 'osx'"
